---
// Theirs
import { GraphQLClient } from "graphql-request";
import path from "path";

// Ours
import { type Data } from "../types/main";
import { document } from "../graphql/main";
import { Stage } from "../constants/main";
import Shero from "../components/Shero.astro";
import Entry from "../components/Entry.astro";
import Footer from "../components/Footer.astro";
import Nav from "src/components/Nav.astro";
import Dialog from "../components/Dialog.astro";
import Head from "../components/Head.astro";
import "../styles/index.css";

// Local
const { moduleId } = Astro.self;
const file = path.basename(moduleId || "");
const { name } = path.parse(file);
const stage = import.meta.env.DEV ? Stage.DRAFT : Stage.PUBLISHED;
const client = new GraphQLClient(import.meta.env.CONTENT);
const data = await client.request<Data>(document(stage));
const [home] = data.pages;
const [message] = data.dialogs;
const {
  shero,
  sections,
  footer,
} = home;

const headings = sections?.map(item => `${item.heading}`) || [""];
---


<html lang="en">
  <Head 
    page={home}
    fileName={name}
  />
  <body>
    {message && <Dialog {...message} />}
    {shero && <Shero {...shero} />}
    <Nav sections={headings} />
    <main>

      {sections?.length && sections.map(section => (
        <Entry sort={section} />
      ))}

    </main>
    {footer && <Footer {...footer} />}
  </body>
</html>


<script>
const collection = [...document.querySelectorAll("[data-lazy]")];
let counter = 0;

const observer = new IntersectionObserver(entries => {
  entries.forEach(entry => {
  function animate() {
    entry.target.removeAttribute("data-lazy");
    observer.unobserve(entry.target);
    counter++;
    
    if (counter === collection.length) observer.disconnect();
  }

    if (entry.isIntersecting) requestAnimationFrame(animate);
  });
}, {
  threshold: [0.4],
});

collection.forEach(item => void observer.observe(item));
</script>
